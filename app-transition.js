// app-transition.js - Version SANS test CORS initial pour d√©bloquer l'app

console.log('üöÄ D√©marrage app-transition.js - Version Bypass CORS');

// ========================================================================
// CONFIGURATION API (identique)
// ========================================================================

const API_CONFIG = {
    BASE_URL: 'https://n8n.dsolution-ia.fr',
    ENDPOINTS: {
        RECHERCHE_ENTREPRISE: '/webhook/recherche_entreprise',
        GATEWAY_ENTITIES: '/webhook/gateway_entities'
    },
    FETCH_OPTIONS: {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        mode: 'cors',
        credentials: 'omit'
    },
    TIMEOUT: 15000
};

// ========================================================================
// FETCH ROBUSTE (identique mais expos√© globalement)
// ========================================================================

window.robustFetch = async function robustFetch(endpoint, payload) {
    const url = `${API_CONFIG.BASE_URL}${endpoint}`;
    
    console.log(`üì§ Requ√™te vers: ${url}`);
    console.log(`üì§ Payload:`, JSON.stringify(payload, null, 2));
    
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.TIMEOUT);
    
    try {
        const fetchOptions = {
            ...API_CONFIG.FETCH_OPTIONS,
            body: JSON.stringify(payload),
            signal: controller.signal
        };
        
        console.log(`üîß Options fetch:`, fetchOptions);
        
        const response = await fetch(url, fetchOptions);
        clearTimeout(timeoutId);
        
        console.log(`üì° Response status: ${response.status}`);
        console.log(`üì° Response ok: ${response.ok}`);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`‚ùå HTTP Error ${response.status}:`, errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const responseText = await response.text();
        console.log(`üì° Response text (premiers 200 chars):`, responseText.substring(0, 200));
        
        let data;
        try {
            data = JSON.parse(responseText);
            console.log(`‚úÖ JSON pars√© avec succ√®s`);
        } catch (jsonError) {
            console.error(`‚ùå Erreur parsing JSON:`, jsonError);
            throw new Error(`R√©ponse JSON invalide: ${jsonError.message}`);
        }
        
        return data;
        
    } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
            throw new Error(`Timeout apr√®s ${API_CONFIG.TIMEOUT}ms`);
        }
        
        if (error.message.includes('CORS')) {
            throw new Error(`Erreur CORS: ${error.message}`);
        }
        
        if (error.message.includes('Failed to fetch')) {
            throw new Error(`Erreur r√©seau: ${error.message}`);
        }
        
        throw error;
    }
}

// ========================================================================
// CLASSE CRM APP - SANS TEST CORS INITIAL
// ========================================================================

class CRMAppTransition {
    constructor() {
        this.isInitialized = false;
        this.user = { first_name: 'St√®ve', id: 123456789 };
        console.log('üöÄ CRMAppTransition cr√©√© - Mode Bypass CORS');
    }

    async initialize() {
        if (this.isInitialized) return;
        
        console.log('üîß Initialisation SANS test CORS...');
        
        try {
            // ‚úÖ SUPPRIM√â : Test CORS initial
            // ‚úÖ DIRECTEMENT : Initialisation normale
            
            this.updateLoadingStatus('Configuration Telegram...');
            this.initializeTelegram();
            await this.delay(300);
            
            this.updateLoadingStatus('Pr√©paration interface...');
            this.showMainMenu();
            await this.delay(300);
            
            this.isInitialized = true;
            this.updateLoadingStatus('Pr√™t !');
            
            // ‚úÖ D√âMASQUER L'APP
            if (window.hideLoadingScreen) {
                window.hideLoadingScreen();
            }
            
            this.showMessage('üöÄ CRM initialis√© avec succ√®s !');
            console.log('‚úÖ Initialisation termin√©e avec succ√®s');
            
        } catch (error) {
            console.error('‚ùå Erreur initialisation:', error);
            this.handleInitializationError(error);
        }
    }

    initializeTelegram() {
        console.log('üì± Initialisation Telegram');
        
        if (typeof window !== 'undefined' && window.Telegram?.WebApp) {
            const tg = window.Telegram.WebApp;
            try {
                tg.ready();
                tg.expand();
                this.user = tg.initDataUnsafe?.user || this.user;
                console.log('‚úÖ Telegram utilisateur:', this.user.first_name);
            } catch (error) {
                console.warn('‚ö†Ô∏è Erreur Telegram:', error);
                this.user = { first_name: 'St√®ve', id: 123456789 };
            }
        } else {
            console.log('üñ•Ô∏è Mode standalone');
            this.user = { first_name: 'St√®ve', id: 123456789 };
        }

        // Mise √† jour UI
        const userNameEl = document.getElementById('userName');
        const userAvatarEl = document.getElementById('userAvatar');
        
        if (userNameEl) userNameEl.textContent = this.user.first_name;
        if (userAvatarEl) userAvatarEl.textContent = this.user.first_name.charAt(0).toUpperCase();
    }

    // ========================================================================
    // NAVIGATION
    // ========================================================================

    showMainMenu() {
        console.log('üè† Menu principal');
        
        const content = `
            <div class="main-menu">
                <h1>üè† Menu Principal</h1>
                <p>CRM Modulaire - Version Bypass CORS</p>
                
                <div class="menu-grid">
                    <div class="menu-item" onclick="appTransition.showSearch()">
                        <div class="icon">üîç</div>
                        <div class="title">Recherche</div>
                        <div class="subtitle">Entreprises</div>
                    </div>
                    
                    <div class="menu-item" onclick="appTransition.testCorsManual()">
                        <div class="icon">üß™</div>
                        <div class="title">Test CORS</div>
                        <div class="subtitle">Diagnostic</div>
                    </div>
                    
                    <div class="menu-item" onclick="appTransition.showAction('stats')">
                        <div class="icon">üìä</div>
                        <div class="title">Statistiques</div>
                        <div class="subtitle">Renouvellement 2026</div>
                    </div>
                    
                    <div class="menu-item" onclick="appTransition.showAction('qualification')">
                        <div class="icon">üíº</div>
                        <div class="title">Qualification</div>
                        <div class="subtitle">Prospects</div>
                    </div>
                </div>
                
                <div class="user-info" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <p><strong>üë§ Utilisateur:</strong> ${this.user.first_name}</p>
                    <p><strong>üîß Mode:</strong> Bypass CORS</p>
                    <p><strong>üåê Status:</strong> ‚úÖ App d√©marr√©e</p>
                </div>
            </div>
        `;
        
        this.updateMainContent(content);
    }

    showSearch() {
        console.log('üîç Interface de recherche');
        
        const content = `
            <div class="search-interface">
                <h2>üîç Recherche Entreprises</h2>
                
                <div class="search-container">
                    <input type="text" 
                           id="searchInput" 
                           placeholder="Tapez le nom de l'entreprise..."
                           oninput="appTransition.handleSearch()"
                           style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px;">
                </div>
                
                <div id="searchResults" class="search-results" style="margin-top: 20px;"></div>
                
                <div class="form-buttons" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="appTransition.showMainMenu()" style="padding: 10px 20px; margin: 5px;">
                        ‚Üê Retour au menu
                    </button>
                    <button class="btn btn-info" onclick="appTransition.testCorsManual()" style="padding: 10px 20px; margin: 5px;">
                        üß™ Test CORS
                    </button>
                </div>
            </div>
        `;
        
        this.updateMainContent(content);
        
        // Focus sur l'input
        setTimeout(() => {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.focus();
                console.log('‚úÖ Focus sur searchInput');
            } else {
                console.error('‚ùå searchInput non trouv√© apr√®s cr√©ation');
            }
        }, 100);
    }

    // ========================================================================
    // RECHERCHE AVEC DEBUG
    // ========================================================================

    async handleSearch() {
        console.log("üöÄ handleSearch() APPEL√âE !");
        
        const searchInput = document.getElementById('searchInput');
        if (!searchInput) {
            console.error("‚ùå searchInput pas trouv√© !");
            return;
        }

        const query = searchInput.value.trim();
        console.log("üîç Query:", query);
        
        if (query.length < 2) {
            console.log("‚ö†Ô∏è Query trop courte");
            this.displaySearchResults([]);
            return;
        }

        try {
            console.log("üì§ AVANT robustFetch");
            this.updateStatus('üîç Recherche en cours...');
            
            const payload = {
                operation: 'getMany',
                search: query,
                limit: 10
            };
            
            console.log('üì§ Payload:', payload);
            console.log("üî• APPEL robustFetch MAINTENANT");
            
            const data = await window.robustFetch(API_CONFIG.ENDPOINTS.RECHERCHE_ENTREPRISE, payload);
            console.log("‚úÖ robustFetch TERMIN√â", data);
            
            // Extraction des donn√©es
            let enterprises = [];
            if (data && data.data && Array.isArray(data.data)) {
                enterprises = data.data;
            } else if (data && Array.isArray(data)) {
                enterprises = data;
            }
            
            console.log(`üìä ${enterprises.length} entreprises trouv√©es`);
            this.displaySearchResults(enterprises);
            this.updateStatus(`‚úÖ ${enterprises.length} r√©sultat(s) trouv√©(s)`);

        } catch (error) {
            console.error('‚ùå Erreur handleSearch:', error);
            this.updateStatus('‚ùå ' + error.message);
            this.displaySearchResults([]);
        }
    }

    // ========================================================================
    // TEST CORS MANUEL
    // ========================================================================

    async testCorsManual() {
        console.log('üß™ Test CORS manuel...');
        this.updateStatus('üß™ Test CORS en cours...');
        
        try {
            const testPayload = {
                operation: 'getMany',
                search: 'test',
                limit: 1
            };
            
            const result = await window.robustFetch(API_CONFIG.ENDPOINTS.RECHERCHE_ENTREPRISE, testPayload);
            console.log('‚úÖ Test CORS r√©ussi:', result);
            this.showMessage('‚úÖ Test CORS r√©ussi ! N8N fonctionne.');
            this.updateStatus('‚úÖ CORS OK');
            
        } catch (error) {
            console.error('‚ùå Test CORS √©chou√©:', error);
            this.showMessage('‚ùå Test CORS √©chou√©: ' + error.message);
            this.updateStatus('‚ùå CORS KO');
        }
    }

    // ========================================================================
    // UTILITAIRES (identiques)
    // ========================================================================

    displaySearchResults(results) {
        const resultsDiv = document.getElementById('searchResults');
        if (!resultsDiv) {
            console.error('‚ùå searchResults div non trouv√©');
            return;
        }

        if (results.length === 0) {
            resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Aucun r√©sultat trouv√©</div>';
        } else {
            resultsDiv.innerHTML = results.map((result, index) => `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; cursor: pointer;" onclick="appTransition.selectEnterprise(${index})">
                    <div style="font-weight: bold; color: #0088cc; margin-bottom: 5px;">${result.nom_entreprise || 'Entreprise'}</div>
                    <div style="color: #666; font-size: 14px;">üìç ${result.commune || 'Commune'} ‚Ä¢ üë§ ${result.interlocuteur || 'Contact'}</div>
                    <div style="color: #666; font-size: 12px;">üìû ${result.telephone || 'Tel'} ‚Ä¢ üìß ${result.email || 'Email'}</div>
                </div>
            `).join('');
            
            window.currentSearchResults = results;
        }
    }

    selectEnterprise(index) {
        const enterprise = window.currentSearchResults?.[index];
        if (!enterprise) return;
        
        console.log('üéØ Entreprise s√©lectionn√©e:', enterprise.nom_entreprise);
        this.showMessage(`Entreprise s√©lectionn√©e: ${enterprise.nom_entreprise}`);
    }

    showAction(actionType) {
        console.log(`üìç Action: ${actionType}`);
        const content = `
            <div class="action-content" style="padding: 20px; text-align: center;">
                <h2>‚ö° ${actionType}</h2>
                <p>Fonctionnalit√© en d√©veloppement.</p>
                <button onclick="appTransition.showMainMenu()" style="padding: 10px 20px; margin: 20px;">üè† Retour au menu</button>
            </div>
        `;
        this.updateMainContent(content);
    }

    updateMainContent(htmlContent) {
        const container = document.getElementById('mainContent') || document.getElementById('app');
        if (container) {
            container.innerHTML = htmlContent;
            console.log('‚úÖ Contenu mis √† jour');
        } else {
            console.error('‚ùå Container principal non trouv√©');
        }
    }

    updateLoadingStatus(message) {
        console.log(`üìù Loading: ${message}`);
        const statusEl = document.getElementById('loadingStatus');
        if (statusEl) statusEl.textContent = message;
    }

    updateStatus(message) {
        console.log(`üìä Status: ${message}`);
        const statusElement = document.getElementById('statusText');
        if (statusElement) statusElement.textContent = message;
    }

    showMessage(message) {
        console.log(`üì¢ Message: ${message}`);
        
        if (window.Telegram?.WebApp?.showAlert) {
            try {
                window.Telegram.WebApp.showAlert(message);
                return;
            } catch (error) {
                console.warn('Telegram alert non support√©');
            }
        }
        
        alert(message);
    }

    handleInitializationError(error) {
        console.error('‚ùå Erreur critique:', error);
        this.updateLoadingStatus('Erreur: ' + error.message);
        
        // ‚úÖ D√âMASQUER L'APP M√äME EN CAS D'ERREUR
        if (window.hideLoadingScreen) {
            window.hideLoadingScreen();
        }
        
        // Afficher une interface d'erreur
        const errorContent = `
            <div style="text-align: center; padding: 40px;">
                <h2 style="color: #dc3545;">‚ùå Erreur d'initialisation</h2>
                <p>${error.message}</p>
                <button onclick="location.reload()" style="padding: 10px 20px; margin: 20px;">üîÑ Recharger</button>
            </div>
        `;
        this.updateMainContent(errorContent);
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// ========================================================================
// INITIALISATION
// ========================================================================

const appTransition = new CRMAppTransition();

// Exposition globale
window.appTransition = appTransition;
window.showMainMenu = () => appTransition.showMainMenu();
window.showSearch = () => appTransition.showSearch();

// D√©marrage
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üìÑ DOM ready - D√©marrage bypass CORS');
        appTransition.initialize();
    });
} else {
    console.log('üìÑ DOM d√©j√† pr√™t - D√©marrage bypass CORS imm√©diat');
    appTransition.initialize();
}

export default appTransition;
console.log('üöÄ app-transition.js Bypass CORS charg√©');